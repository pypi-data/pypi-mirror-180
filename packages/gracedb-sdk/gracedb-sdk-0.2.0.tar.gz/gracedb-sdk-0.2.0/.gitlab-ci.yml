include:
  - project: computing/gitlab-ci-templates
    file: python.yml
  - project: computing/gitlab-ci-templates
    file: workflow/sccb.yml

# Build source and binary distributions
build:
  image: python
  extends:
    - .python:build

.test: &test
  stage: test
  extends:
    - .python:pytest
  before_script:  # Install robot keytab for integration tests
    - !reference [".python:pytest", "before_script"]
    - apt-get update
    - DEBIAN_FRONTEND=noninteractive apt-get install -y krb5-user
    # Decode base64-encoded keytab
    - echo "${ROBOT_KEYTAB}" | base64 -d | install -m 0600 /dev/stdin keytab
    # Read principal from first entry in keytab
    - PRINCIPAL=$(klist -k keytab | head -n 4 | tail -n 1 | sed -E 's/^.* +//')
    # Create X.509 certificate
    - kinit $PRINCIPAL -k -t keytab
    - rm keytab
    - ligo-proxy-init -k
  variables:
    TESTS_REQUIRE: ligo-proxy-utils requests-gssapi
  # Do not run more than one unit test job at once, because GraceDB has race
  # conditions when multiple clients are creating superevents.
  resource_group: gracedb-test.ligo.org

test-3.7:
  image: python:3.7
  <<: *test

test-3.8:
  image: python:3.8
  <<: *test

test-3.9:
  image: python:3.9
  <<: *test

test-3.10:
  image: python:3.10
  <<: *test

test-3.11:
  image: python:3.11
  <<: *test

# SCCB request
sccb:
  stage: deploy

# Upload package to PyPI.
# Place your PyPI API token in the repository's GitLab CI secrets.
pypi:
  stage: deploy
  image: python:slim
  extends:
    - .python:twine
  variables:
    TWINE_PASSWORD: $PYPI_API_TOKEN
  dependencies:
    - build
  only:
    - tags@emfollow/gracedb-sdk
