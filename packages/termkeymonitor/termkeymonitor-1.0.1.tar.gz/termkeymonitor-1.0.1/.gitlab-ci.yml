include:
    # Python black and PEP8 code style check
    - "https://gitlab.com/nobodyinperson/ci-templates/raw/master/python-black-pep8.yml"
    # PyPI upload
    - "https://gitlab.com/nobodyinperson/ci-templates/raw/master/pypi-upload.yml"

image: python:latest

stages:
    - test
    - package
    - deploy

python-black-pep8:
    stage: test

dist:
    stage: package
    dependencies: [] # no other artifacts needed
    needs: [] # can start directly
    before_script:
        - apt-get update -qq
        - apt-get install -y -qq gettext
    script:
        - ./setup.py sdist
    artifacts:
        paths:
            - dist/*
        expire_in: 1 week

pypi-upload:
    stage: deploy
    environment:
        name: Python Package Index
        url: https://pypi.org/project/mqtt_dispatcher/
    dependencies:
        - dist
    only:
        - main
    only:
        - tags

